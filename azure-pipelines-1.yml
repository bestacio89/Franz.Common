trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: 'Secrets and variables'
- name: buildConfiguration
  value: 'Release'
- name: projectName
  value: 'Franz.Common'
- name: outputDir
  value: '$(Build.ArtifactStagingDirectory)/packages'
- name: azureOrg
  value: 'AjnaTellus'
- name: feedName
  value: 'AjnaTellus'

steps:

# ðŸ§¾ Checkout with full history for 34k LOC integrity
- checkout: self
  persistCredentials: true
  fetchDepth: 0 

# ðŸ” Auth & Environment Setup
- task: NuGetAuthenticate@1
  displayName: 'Authenticate Azure Artifacts'

- task: UseDotNet@2
  displayName: 'Use .NET SDK 10.x'
  inputs:
    packageType: 'sdk'
    version: '10.x'

# ðŸ—ï¸ Standard Build/Test/Pack Chain
- script: dotnet restore
  displayName: 'Restore'

- script: dotnet build --configuration $(buildConfiguration) --no-restore
  displayName: 'Build'

- script: dotnet test --configuration $(buildConfiguration) --no-build --logger trx
  displayName: 'Test'

- script: dotnet pack --configuration $(buildConfiguration) --no-build --output $(outputDir)
  displayName: 'Pack'

# ðŸš€ 1. Publish to Internal Azure Artifacts (Main Only)
- script: |
    dotnet nuget push "$(outputDir)/*.nupkg" \
      --source "https://pkgs.dev.azure.com/$(azureOrg)/_packaging/$(feedName)/nuget/V3/index.json" \
      --api-key $(System.AccessToken) \
      --skip-duplicate
  displayName: 'Publish to Azure Feed'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))

# ----------------------------------------------------------------
# 2. ðŸš€ GITHUB DEVELOP SYNC
# ----------------------------------------------------------------
- script: |
    set -euo pipefail
    git remote add github "https://$(GITHUB_USER):$(GITHUB_TOKEN)@github.com/bestacio89/Franz.Common.git" || git remote set-url github "https://$(GITHUB_USER):$(GITHUB_TOKEN)@github.com/bestacio89/Franz.Common.git"
    git push --force github origin/Develop:refs/heads/develop
  displayName: 'Sync GitHub: Develop'
  env: { GITHUB_USER: $(GITHUB_USER), GITHUB_TOKEN: $(GITHUB_TOKEN) }

# ----------------------------------------------------------------
# 3. ðŸ¦Š GITLAB DEVELOP SYNC
# ----------------------------------------------------------------
- script: |
    set -euo pipefail
    git remote remove gitlab || true
    git remote add gitlab "https://gitlab.com/bernardo.estacio89/franz.common.git"
    AUTH=$(echo -n "oauth2:$(GITLAB_TOKEN)" | base64 | tr -d '\n')
    echo "Pushing Develop to GitLab..."
    git -c http.extraheader="Authorization: Basic ${AUTH}" push --force gitlab origin/Develop:refs/heads/develop
  displayName: 'Sync GitLab: Develop'
  env: { GITLAB_TOKEN: $(GITLAB_TOKEN) }

# ----------------------------------------------------------------
# 4. ðŸš€ GITHUB MAIN & TAGS SYNC
# ----------------------------------------------------------------
- script: |
    set -euo pipefail
    git remote add github "https://$(GITHUB_USER):$(GITHUB_TOKEN)@github.com/bestacio89/Franz.Common.git" || git remote set-url github "https://$(GITHUB_USER):$(GITHUB_TOKEN)@github.com/bestacio89/Franz.Common.git"
    git push --force github origin/main:refs/heads/main
    git fetch --tags --force
    LATEST_TAG=$(git describe --tags --exact-match 2>/dev/null || git describe --tags --abbrev=0 || true)
    if [ -n "$LATEST_TAG" ]; then
      git push github "$LATEST_TAG"
    fi
  displayName: 'Sync GitHub: Main + Tags'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  env: { GITHUB_USER: $(GITHUB_USER), GITHUB_TOKEN: $(GITHUB_TOKEN) }

# ----------------------------------------------------------------
# 5. ðŸ¦Š GITLAB MAIN & TAGS SYNC
# ----------------------------------------------------------------
- script: |
    set -euo pipefail
    git remote remove gitlab || true
    git remote add gitlab "https://gitlab.com/bernardo.estacio89/franz.common.git"
    AUTH=$(echo -n "oauth2:$(GITLAB_TOKEN)" | base64 | tr -d '\n')
    echo "Pushing Main and Tags to GitLab..."
    git -c http.extraheader="Authorization: Basic ${AUTH}" push --force gitlab origin/main:refs/heads/main
    git fetch --tags --force
    LATEST_TAG=$(git describe --tags --exact-match 2>/dev/null || git describe --tags --abbrev=0 || true)
    [ -z "$LATEST_TAG" ] || git -c http.extraheader="Authorization: Basic ${AUTH}" push gitlab "$LATEST_TAG"
  displayName: 'Sync GitLab: Main + Tags'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  env: { GITLAB_TOKEN: $(GITLAB_TOKEN) }