trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: 'Secrets and variables'

- name: buildConfiguration
  value: 'Release'

- name: projectName
  value: 'Franz.Common'

- name: outputDir
  value: '$(Build.ArtifactStagingDirectory)/packages'

# Azure Artifacts
- name: azureOrg
  value: 'AjnaTellus'

- name: feedName
  value: 'AjnaTellus'

steps:

# üßæ Checkout
- checkout: self
  persistCredentials: true

# üîê Authenticate to Azure Artifacts
- task: NuGetAuthenticate@1
  displayName: 'Authenticate to Azure Artifacts'

# ‚öôÔ∏è Install .NET SDK
- task: UseDotNet@2
  displayName: 'Use .NET SDK 10.x'
  inputs:
    packageType: 'sdk'
    version: '10.x'

# üîß Restore
- script: dotnet restore
  displayName: 'Restore dependencies'

# üèóÔ∏è Build
- script: dotnet build --configuration $(buildConfiguration) --no-restore
  displayName: 'Build solution'

# üß™ Test
- script: dotnet test --configuration $(buildConfiguration) --no-build --logger trx
  displayName: 'Run unit tests'

# üì¶ Pack
- script: dotnet pack --configuration $(buildConfiguration) --no-build --output $(outputDir)
  displayName: 'Pack NuGet packages'

# üöÄ Publish to Azure Artifacts (main only)
- script: |
    echo "Publishing packages to Azure Artifacts feed..."
    dotnet nuget push "$(outputDir)/*.nupkg" \
      --source "https://pkgs.dev.azure.com/$(azureOrg)/_packaging/$(feedName)/nuget/V3/index.json" \
      --api-key $(System.AccessToken) \
      --skip-duplicate
  displayName: 'Publish packages to Azure Artifacts'
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')

# üîÅ Mirror main + Develop branches to GitHub (Azure = source of truth)
- script: |
    set -euo pipefail
    
    echo "Starting Atomic Mirror to GitHub..."

    # Configure Auth
    git remote add github "https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com/bestacio89/Franz.Common.git" || \
    git remote set-url github "https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com/bestacio89/Franz.Common.git"

    # 1. Fetch ALL refs from Azure (Source of Truth) to ensure we have every object
    git fetch origin --prune --unshallow || git fetch origin --prune

    # 2. Push specific branches directly without checking them out
    # This avoids "unpack failed" errors caused by local HEAD states
    echo "Pushing main..."
    git push --force github origin/main:refs/heads/main
    
    echo "Pushing develop..."
    git push --force github origin/Develop:refs/heads/Develop

    echo "‚úÖ Mirroring Complete"
  displayName: 'Mirror to GitHub (Atomic)'
  env:
    GITHUB_USER: $(GITHUB_USER)
    GITHUB_TOKEN: $(GITHUB_TOKEN)

# ü¶ä Mirror to GitLab (Final Redundancy Gate)
- script: |
    set -euo pipefail

    echo "Initialising GitLab Remote..."
    # Using 'set-url' or 'add' ensures we don't fail if the remote exists
    git remote add gitlab "https://${GITLAB_USER}:${GITLAB_TOKEN}@gitlab.com/bernardo.estacio89/franz.common.git" || \
    git remote set-url gitlab "https://${GITLAB_USER}:${GITLAB_TOKEN}@gitlab.com/bernardo.estacio89/franz.common.git"

    # Ensure we have the full object tree for the 63 projects
    echo "Fetching object deltas..."
    git fetch origin --prune --unshallow || git fetch origin --prune

    echo "Mirroring Main and Develop to GitLab..."
    # Directly map the verified Azure refs to GitLab refs
    git push --force gitlab origin/main:refs/heads/main
    git push --force gitlab origin/Develop:refs/heads/develop

    echo "‚úÖ Mission Accomplished: GitLab is in sync."
  displayName: 'Mirror to GitLab'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  env:
    GITLAB_USER: $(GITLAB_USER)
    GITLAB_TOKEN: $(GITLAB_TOKEN)

# üè∑Ô∏è Propagate tags (High-Reliability Sync)
- script: |
    set -euo pipefail

    echo "Fetching all tags from Azure DevOps (Source of Truth)..."
    git fetch --tags --force

    # Identify the latest tag on the current verified commit
    LATEST_TAG=$(git describe --tags --exact-match 2>/dev/null || git describe --tags --abbrev=0 || true)

    if [ -n "$LATEST_TAG" ]; then
      echo "Verified Tag Found: $LATEST_TAG"
      
      # Push specifically to GitHub
      echo "Pushing $LATEST_TAG to GitHub..."
      git push github "$LATEST_TAG"

      # Push specifically to GitLab
      echo "Pushing $LATEST_TAG to GitLab..."
      git push gitlab "$LATEST_TAG"
      
      echo "‚úÖ Tag propagation complete."
    else
      echo "‚ÑπÔ∏è No tag found on the current commit to propagate."
    fi
  displayName: 'Propagate tags to GitHub & GitLab'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
