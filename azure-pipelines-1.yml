trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: 'Secrets and variables'

- name: buildConfiguration
  value: 'Release'

- name: projectName
  value: 'Franz.Common'

- name: outputDir
  value: '$(Build.ArtifactStagingDirectory)/packages'

# Azure Artifacts
- name: azureOrg
  value: 'AjnaTellus'

- name: feedName
  value: 'AjnaTellus'

steps:

# üßæ Checkout
- checkout: self
  persistCredentials: true

# üîê Authenticate to Azure Artifacts
- task: NuGetAuthenticate@1
  displayName: 'Authenticate to Azure Artifacts'

# ‚öôÔ∏è Install .NET SDK
- task: UseDotNet@2
  displayName: 'Use .NET SDK 10.x'
  inputs:
    packageType: 'sdk'
    version: '10.x'

# üîß Restore
- script: dotnet restore
  displayName: 'Restore dependencies'

# üèóÔ∏è Build
- script: dotnet build --configuration $(buildConfiguration) --no-restore
  displayName: 'Build solution'

# üß™ Test
- script: dotnet test --configuration $(buildConfiguration) --no-build --logger trx
  displayName: 'Run unit tests'

# üì¶ Pack
- script: dotnet pack --configuration $(buildConfiguration) --no-build --output $(outputDir)
  displayName: 'Pack NuGet packages'

# üöÄ Publish to Azure Artifacts (main only)
- script: |
    echo "Publishing packages to Azure Artifacts feed..."
    dotnet nuget push "$(outputDir)/*.nupkg" \
      --source "https://pkgs.dev.azure.com/$(azureOrg)/_packaging/$(feedName)/nuget/V3/index.json" \
      --api-key $(System.AccessToken) \
      --skip-duplicate
  displayName: 'Publish packages to Azure Artifacts'
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')

# üîÅ Mirror main + develop branches to GitHub
- script: |
    set -euo pipefail
    # Make sure GitHub variables exist in Bash
    export GITHUB_USER=$(GITHUB_USER)
    export GITHUB_TOKEN=$(GITHUB_TOKEN)
    
    # Git identity
    git config user.name "Azure DevOps"
    git config user.email "build@azure.devops"

    # Remove and re-add remote
    git remote remove github || true
    git remote add github "https://$(GITHUB_USER):$(GITHUB_TOKEN)@github.com/bestacio89/Franz.Common.git"

    # Branches to mirror
    BRANCHES=("main" "develop")

    for BRANCH in "${BRANCHES[@]}"; do
        echo "=== Mirroring branch $BRANCH ==="

        # Fetch the branch from origin
        git fetch origin $BRANCH || echo "Branch $BRANCH does not exist locally yet"

        # Check if branch exists locally, create tracking if missing
        if git show-ref --verify --quiet refs/heads/$BRANCH; then
            git checkout $BRANCH
        else
            git checkout -b $BRANCH origin/$BRANCH
        fi

        # Force push to GitHub safely
        git push --force github $BRANCH:$BRANCH || {
            echo "Failed to push $BRANCH to GitHub, attempting recreate"
            git push --force github +$BRANCH:$BRANCH
        }

        echo "=== Done mirroring $BRANCH ==="
    done

    # Optional: mirror tags (uncomment if needed)
    # git push --tags github --force
  displayName: 'Mirror main + develop to GitHub'
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')




# ü¶ä Mirror to GitLab
- script: |
    set -e

    git remote remove gitlab || true
    git remote add gitlab "https://$(GITLAB_USER):$(GITLAB_TOKEN)@gitlab.com/bernardo.estacio89/franz.common.git"

    echo "Pushing branch $(Build.SourceBranchName) to GitLab"
    git push gitlab HEAD:refs/heads/$(Build.SourceBranchName)
  displayName: 'Mirror branch to GitLab'
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')

# üè∑Ô∏è Propagate tags (main only)
- script: |
    set -e

    git fetch --tags

    LATEST_TAG=$(git describe --tags --abbrev=0 || true)

    if [ -n "$LATEST_TAG" ]; then
      echo "Propagating tag $LATEST_TAG"
      git push github $LATEST_TAG
      git push gitlab $LATEST_TAG
    else
      echo "No tags to propagate"
    fi
  displayName: 'Propagate tags to GitHub & GitLab'
  condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
