trigger:
- Develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'

steps:
# Checkout with full history + credentials
- checkout: self
  persistCredentials: 'true'
  fetchDepth: '0'

# Install .NET 10 SDK
- task: UseDotNet@2
  displayName: 'Install .NET 10 SDK'
  inputs:
    packageType: 'sdk'
    version: '10.0.x'
    includePreviewVersions: true

# Authenticate to Azure Artifacts
- task: NuGetAuthenticate@1
  displayName: 'Authenticate to Azure Artifacts'

# Restore
- script: dotnet restore
  displayName: 'Restore NuGet packages'

# Build
- script: dotnet build --configuration $(buildConfiguration) --no-restore
  displayName: 'Build solution'

# Test
- script: dotnet test --configuration $(buildConfiguration) --no-build --verbosity normal
  displayName: 'Run tests'

# Promote Develop → main
- script: |
    set -euo pipefail

    echo "Promoting Develop → main"

    # Git identity
    git config user.name "Azure DevOps"
    git config user.email "build@azuredevops"

    # Fetch latest from origin
    git fetch origin

    # Checkout main (create if missing)
    git checkout main || git checkout -b main origin/main

    # Get the latest commit message from Develop
    COMMIT_MSG=$(git log origin/Develop -1 --pretty=%B)

    # Merge Develop into main using that commit message
    git merge origin/Develop --no-ff -m "$COMMIT_MSG"

    # Push main
    git push origin main
  displayName: 'Promote Develop → Main (with commit message)'
  condition: succeeded()