trigger:
- Develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'

steps:
# Checkout with full history + credentials
- checkout: self
  persistCredentials: 'true'
  fetchDepth: '0'

# Install .NET 10 SDK
- task: UseDotNet@2
  displayName: 'Install .NET 10 SDK'
  inputs:
    packageType: 'sdk'
    version: '10.0.x'
    includePreviewVersions: true

# Authenticate to Azure Artifacts
- task: NuGetAuthenticate@1
  displayName: 'Authenticate to Azure Artifacts'

# Restore
- script: dotnet restore
  displayName: 'Restore NuGet packages'

# Build
- script: dotnet build --configuration $(buildConfiguration) --no-restore
  displayName: 'Build solution'

# Test
- script: dotnet test --configuration $(buildConfiguration) --no-build --verbosity normal
  displayName: 'Run tests'

  # ðŸ§ª Mirror Develop to GitHub & GitLab
- script: |
    set -euo pipefail

    # Setup Remotes
    git remote add github "https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com/bestacio89/Franz.Common.git" || git remote set-url github "https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com/bestacio89/Franz.Common.git"
    git remote add gitlab "https://${GITLAB_USER}:${GITLAB_TOKEN}@gitlab.com/bernardo.estacio89/franz.common.git" || git remote set-url gitlab "https://${GITLAB_USER}:${GITLAB_TOKEN}@gitlab.com/bernardo.estacio89/franz.common.git"

    # Clean the agent cache
    git fetch origin --prune --unshallow || git fetch origin --prune

    echo "ðŸš€ Syncing verified Develop branch to Mirrors..."
    # The Prune One-Liner: Syncs Develop and removes stale feature-branch artifacts
    git push --force --prune github origin/Develop:refs/heads/develop
    git push --force --prune gitlab origin/Develop:refs/heads/develop

  displayName: 'Sync Develop Mirror'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/Develop'))
  env:
    GITHUB_USER: $(GITHUB_USER)
    GITHUB_TOKEN: $(GITHUB_TOKEN)
    GITLAB_USER: $(GITLAB_USER)
    GITLAB_TOKEN: $(GITLAB_TOKEN)

# Promote Develop â†’ main
- script: |
    set -euo pipefail

    echo "Promoting Develop â†’ main"

    # Git identity
    git config user.name "Azure DevOps"
    git config user.email "build@azuredevops"

    # Fetch latest from origin
    git fetch origin

    # Checkout main (create if missing)
    git checkout main || git checkout -b main origin/main

    # Get the latest commit message from Develop
    COMMIT_MSG=$(git log origin/Develop -1 --pretty=%B)

    # Merge Develop into main using that commit message
    git merge origin/Develop --no-ff -m "$COMMIT_MSG"

    # Push main
    git push origin main
  displayName: 'Promote Develop â†’ Main (with commit message)'
  condition: succeeded()