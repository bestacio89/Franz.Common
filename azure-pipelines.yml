trigger:
- Develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'

steps:
# Checkout with full history + credentials
- checkout: self
  persistCredentials: 'true'
  fetchDepth: '0'

# Install .NET 10 SDK
- task: UseDotNet@2
  displayName: 'Install .NET 10 SDK'
  inputs:
    packageType: 'sdk'
    version: '10.0.x'
    includePreviewVersions: true

# Authenticate to Azure Artifacts
- task: NuGetAuthenticate@1
  displayName: 'Authenticate to Azure Artifacts'

# Restore
- script: dotnet restore
  displayName: 'Restore NuGet packages'

# Build
- script: dotnet build --configuration $(buildConfiguration) --no-restore
  displayName: 'Build solution'

# Test
- script: dotnet test --configuration $(buildConfiguration) --no-build --verbosity normal
  displayName: 'Run tests'

  # ðŸ§ª Mirror Develop to GitHub & GitLab
- script: |
    set -euo pipefail

    # 1. Smart Fetch (Silences the 'complete repository' warning)
    if [ -f .git/shallow ]; then
      echo "Unshallowing repo for full history..."
      git fetch origin --prune --unshallow
    else
      echo "Repo is already complete, skipping unshallow."
      git fetch origin --prune
    fi

    # 2. Configure Auth Header (More reliable than URL embedding)
    # This prevents the "Invalid username or token" error caused by URL parsing
    git config --global url."https://${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
    git config --global url."https://oauth2:${GITLAB_TOKEN}@gitlab.com/".insteadOf "https://gitlab.com/"

    # 3. Setup Remotes (Standard URLs)
    git remote add github "https://github.com/bestacio89/Franz.Common.git" || git remote set-url github "https://github.com/bestacio89/Franz.Common.git"
    git remote add gitlab "https://gitlab.com/bernardo.estacio89/franz.common.git" || git remote set-url gitlab "https://gitlab.com/bernardo.estacio89/franz.common.git"

    echo "ðŸš€ Syncing verified $(Build.SourceBranchName) branch to Mirrors..."
    
    # We use the refspec to ensure exact matching
    git push --force github origin/$(Build.SourceBranchName):refs/heads/$(Build.SourceBranchName)
    git push --force gitlab origin/$(Build.SourceBranchName):refs/heads/$(Build.SourceBranchName)

  displayName: 'Sync Develop Mirror (Auth Fixed)'
  condition: succeeded()
  env:
    GITHUB_TOKEN: $(GITHUB_TOKEN)
    GITLAB_TOKEN: $(GITLAB_TOKEN)

# Promote Develop â†’ main
- script: |
    set -euo pipefail

    echo "Promoting Develop â†’ main"

    # Git identity
    git config user.name "Azure DevOps"
    git config user.email "build@azuredevops"

    # Fetch latest from origin
    git fetch origin

    # Checkout main (create if missing)
    git checkout main || git checkout -b main origin/main

    # Get the latest commit message from Develop
    COMMIT_MSG=$(git log origin/Develop -1 --pretty=%B)

    # Merge Develop into main using that commit message
    git merge origin/Develop --no-ff -m "$COMMIT_MSG"

    # Push main
    git push origin main
  displayName: 'Promote Develop â†’ Main (with commit message)'
  condition: succeeded()